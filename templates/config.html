{% extends "base.html" %}
{% block content %}
<section class="panel hero">
  <div>
    <h1>Targets & Offsets</h1>
    <p>Edit targets, tolerances, and offsets in inches.</p>
  </div>
</section>

<section class="panel">
  <form method="post">
    <div class="grid two">
      <div id="targets-section">
        <h2>Targets & Tolerances</h2>
        <div class="form-grid">
          <label>d1 target (in)</label>
          <input type="text" inputmode="decimal" pattern="-?[0-9]*[.]?[0-9]*" class="num-input" step="0.001" autocomplete="off" name="d1_target_in" value="{{ format_float(cfg.targets.d1_target / 25.4) }}" required readonly>

          <label>d1 tol (in)</label>
          <input type="text" inputmode="decimal" pattern="-?[0-9]*[.]?[0-9]*" class="num-input" step="0.001" autocomplete="off" name="d1_tol_in" value="{{ format_float(cfg.targets.d1_tol / 25.4) }}" required readonly>

          <label>d2 target (in)</label>
          <input type="text" inputmode="decimal" pattern="-?[0-9]*[.]?[0-9]*" class="num-input" step="0.001" autocomplete="off" name="d2_target_in" value="{{ format_float(cfg.targets.d2_target / 25.4) }}" required readonly>

          <label>d2 tol (in)</label>
          <input type="text" inputmode="decimal" pattern="-?[0-9]*[.]?[0-9]*" class="num-input" step="0.001" autocomplete="off" name="d2_tol_in" value="{{ format_float(cfg.targets.d2_tol / 25.4) }}" required readonly>

          <label>length target (in)</label>
          <input type="text" inputmode="decimal" pattern="-?[0-9]*[.]?[0-9]*" class="num-input" step="0.001" autocomplete="off" name="len_target_in" value="{{ format_float(cfg.targets.len_target / 25.4) }}" required readonly>

          <label>length tol (in)</label>
          <input type="text" inputmode="decimal" pattern="-?[0-9]*[.]?[0-9]*" class="num-input" step="0.001" autocomplete="off" name="len_tol_in" value="{{ format_float(cfg.targets.len_tol / 25.4) }}" required readonly>

          <label>dDelta max (in)</label>
          <input type="text" inputmode="decimal" pattern="-?[0-9]*[.]?[0-9]*" class="num-input" step="0.001" autocomplete="off" name="ddelta_max_in" value="{{ format_float(cfg.targets.dDelta_max / 25.4) }}" required readonly>

          <label>end1 max (in)</label>
          <input type="text" inputmode="decimal" pattern="-?[0-9]*[.]?[0-9]*" class="num-input" step="0.001" autocomplete="off" name="end1_max_in" value="{{ format_float(cfg.targets.end1_max / 25.4) }}" required readonly>

          <label>end2 max (in)</label>
          <input type="text" inputmode="decimal" pattern="-?[0-9]*[.]?[0-9]*" class="num-input" step="0.001" autocomplete="off" name="end2_max_in" value="{{ format_float(cfg.targets.end2_max / 25.4) }}" required readonly>
        </div>
      </div>
      <div id="offsets-section">
        <h2>Offsets</h2>
        <div class="form-grid">
          {% for idx in range(8) %}
          <label>off{{ idx }} (in)</label>
          <input type="text" inputmode="decimal" pattern="-?[0-9]*[.]?[0-9]*" class="num-input" step="0.001" autocomplete="off" name="off{{ idx }}_in" value="{{ format_float(offsets_in[idx]) }}" required readonly>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn" formaction="/targets/apply" type="submit">Apply (Live)</button>
      <button class="btn btn-primary" formaction="/targets/save" type="submit">Save to Disk</button>
    </div>
  </form>
</section>

<div id="keypad" class="keypad">
  <div class="keypad-panel">
    <div class="keypad-title" id="keypad-label">Enter value</div>
    <div class="keypad-display" id="keypad-display">0</div>
    <div class="keypad-grid">
      <button type="button" class="keypad-btn" data-key="7">7</button>
      <button type="button" class="keypad-btn" data-key="8">8</button>
      <button type="button" class="keypad-btn" data-key="9">9</button>
      <button type="button" class="keypad-btn" data-key="4">4</button>
      <button type="button" class="keypad-btn" data-key="5">5</button>
      <button type="button" class="keypad-btn" data-key="6">6</button>
      <button type="button" class="keypad-btn" data-key="1">1</button>
      <button type="button" class="keypad-btn" data-key="2">2</button>
      <button type="button" class="keypad-btn" data-key="3">3</button>
      <button type="button" class="keypad-btn" data-key=".">.</button>
      <button type="button" class="keypad-btn" data-key="0">0</button>
      <button type="button" class="keypad-btn" data-action="backspace">DEL</button>
    </div>
    <div class="keypad-actions">
      <button type="button" class="keypad-btn keypad-btn-light" data-action="clear">Clear</button>
      <button type="button" class="keypad-btn keypad-btn-light" data-action="sign">+/-</button>
      <button type="button" class="keypad-btn keypad-btn-primary" data-action="ok">OK</button>
    </div>
  </div>
</div>

<script>
  (function () {
    var keypad = document.getElementById("keypad");
    var display = document.getElementById("keypad-display");
    var label = document.getElementById("keypad-label");
    var activeInput = null;

    function updateDisplay() {
      if (!activeInput) {
        return;
      }
      var value = activeInput.value || "";
      display.textContent = value === "" ? "0" : value;
      var labelNode = activeInput.previousElementSibling;
      if (labelNode && labelNode.tagName === "LABEL") {
        label.textContent = labelNode.textContent.replace("(in)", "").trim();
      } else {
        label.textContent = "Enter value";
      }
    }

    function openKeypad(input) {
      activeInput = input;
      keypad.classList.add("open");
      updateDisplay();
    }

    function closeKeypad() {
      keypad.classList.remove("open");
      activeInput = null;
    }

    document.querySelectorAll(".num-input").forEach(function (input) {
      input.addEventListener("focus", function () {
        openKeypad(input);
      });
      input.addEventListener("click", function () {
        openKeypad(input);
      });
    });

    keypad.addEventListener("click", function (event) {
      if (event.target === keypad) {
        closeKeypad();
      }
    });

    keypad.querySelectorAll("[data-key]").forEach(function (btn) {
      btn.addEventListener("click", function () {
        if (!activeInput) {
          return;
        }
        var key = btn.getAttribute("data-key");
        var current = activeInput.value || "";
        if (key === "." && current.indexOf(".") !== -1) {
          return;
        }
        activeInput.value = current + key;
        updateDisplay();
      });
    });

    keypad.querySelectorAll("[data-action]").forEach(function (btn) {
      btn.addEventListener("click", function () {
        if (!activeInput) {
          return;
        }
        var action = btn.getAttribute("data-action");
        var current = activeInput.value || "";
        if (action === "clear") {
          activeInput.value = "";
        } else if (action === "backspace") {
          activeInput.value = current.slice(0, -1);
        } else if (action === "sign") {
          if (current.startsWith("-")) {
            activeInput.value = current.slice(1);
          } else if (current.length) {
            activeInput.value = "-" + current;
          } else {
            activeInput.value = "-";
          }
        } else if (action === "ok") {
          closeKeypad();
          return;
        }
        updateDisplay();
      });
    });
  })();
</script>
{% endblock %}
